<dashboard version="1.1" theme="dark">
  <label>Infrastructure Health</label>
  <description>VM Status, Swarm Cluster, Service Discovery</description>
  
  <row>
    <panel>
      <title>ğŸ–¥ï¸ VM / Node Status</title>
      <table>
        <search>
          <query>
| tstats latest(_time) as last_seen count WHERE index=* earliest=-24h by host
| eval age_minutes = round((now() - last_seen) / 60, 1)
| eval status = case(
    age_minutes &lt; 2, "ğŸŸ¢ Active",
    age_minutes &lt; 10, "ğŸŸ¡ Idle",
    age_minutes &lt; 60, "ğŸŸ  Stale",
    true(), "ğŸ”´ Offline"
)
| convert ctime(last_seen)
| table host status last_seen age_minutes count
| rename host as "Node" status as "Status" last_seen as "Last Seen" age_minutes as "Age (min)" count as "Events (24h)"
| sort age_minutes
          </query>
          <earliest>-24h</earliest>
          <latest>now</latest>
          <refresh>30s</refresh>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
    <panel>
      <title>Docker Swarm Cluster</title>
      <table>
        <search>
          <query>
index=docker sourcetype="docker:swarm:node" earliest=-5m
| dedup hostname
| eval role = if(manager_status="leader", "ğŸ”· Leader", if(isnotnull(manager_status), "ğŸ”¹ Manager", "âšª Worker"))
| eval health = case(
    status="ready" AND availability="active", "ğŸŸ¢ Healthy",
    status="ready", "ğŸŸ¡ Available",
    true(), "ğŸ”´ Unhealthy"
)
| table hostname role health status availability
| rename hostname as "Node" role as "Role" health as "Health" status as "Status" availability as "Availability"
          </query>
          <earliest>-5m</earliest>
          <latest>now</latest>
          <refresh>30s</refresh>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
  </row>

  <row>
    <panel>
      <title>Swarm Services Status</title>
      <table>
        <search>
          <query>
index=docker sourcetype="docker:swarm:service" earliest=-5m
| dedup name
| eval health = case(
    replicas="0/0", "âšª Scaled Down",
    match(replicas, "^\d+/\d+$") AND mvindex(split(replicas,"/"),0)==mvindex(split(replicas,"/"),1), "ğŸŸ¢ Healthy",
    true(), "ğŸŸ¡ Scaling"
)
| table name mode replicas health image
| rename name as "Service" mode as "Mode" replicas as "Replicas" health as "Health" image as "Image"
          </query>
          <earliest>-5m</earliest>
          <latest>now</latest>
          <refresh>30s</refresh>
        </search>
        <option name="drilldown">none</option>
        <option name="count">20</option>
      </table>
    </panel>
  </row>

  <row>
    <panel>
      <title>Container Distribution by Host</title>
      <chart>
        <search>
          <query>
index=docker sourcetype="docker:container:status" earliest=-5m
| dedup names host
| stats count by host
          </query>
          <earliest>-5m</earliest>
          <latest>now</latest>
          <refresh>30s</refresh>
        </search>
        <option name="charting.chart">pie</option>
      </chart>
    </panel>
    <panel>
      <title>Services by Host</title>
      <chart>
        <search>
          <query>
index=docker sourcetype="docker:container:status" earliest=-5m
| dedup names host
| stats count by host
| rename count as "Containers"
          </query>
          <earliest>-5m</earliest>
          <latest>now</latest>
          <refresh>30s</refresh>
        </search>
        <option name="charting.chart">bar</option>
      </chart>
    </panel>
  </row>

  <row>
    <panel>
      <title>All Running Containers</title>
      <table>
        <search>
          <query>
index=docker sourcetype="docker:container:status" earliest=-5m
| dedup names
| rex field=status "Up (?&lt;uptime&gt;[^(]+)"
| table names image uptime ports host
| rename names as "Container" image as "Image" uptime as "Uptime" ports as "Ports" host as "Host"
| sort Container
          </query>
          <earliest>-5m</earliest>
          <latest>now</latest>
          <refresh>30s</refresh>
        </search>
        <option name="drilldown">none</option>
        <option name="count">30</option>
      </table>
    </panel>
  </row>

  <row>
    <panel>
      <title>Event Rate by Host (Last Hour)</title>
      <chart>
        <search>
          <query>
| tstats count WHERE index=* earliest=-1h by _time host span=5m
          </query>
          <earliest>-1h</earliest>
          <latest>now</latest>
          <refresh>60s</refresh>
        </search>
        <option name="charting.chart">line</option>
        <option name="charting.legend.placement">right</option>
      </chart>
    </panel>
  </row>

  <row>
    <panel>
      <title>Index Distribution by Host</title>
      <table>
        <search>
          <query>
| tstats count WHERE index=* earliest=-24h by index host
| chart sum(count) as events over host by index
          </query>
          <earliest>-24h</earliest>
          <latest>now</latest>
          <refresh>60s</refresh>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
  </row>

  <row>
    <panel>
      <title>Recent Container Restarts/Crashes</title>
      <table>
        <search>
          <query>
index=docker (restart OR "Exited" OR crash OR killed) earliest=-24h
| table _time host source _raw
| sort -_time
| head 15
          </query>
          <earliest>-24h</earliest>
          <latest>now</latest>
          <refresh>60s</refresh>
        </search>
        <option name="drilldown">none</option>
        <option name="wrap">true</option>
      </table>
    </panel>
    <panel>
      <title>Service Errors</title>
      <table>
        <search>
          <query>
index=* (error OR Error OR ERROR OR fail OR critical) earliest=-4h
| stats count by host index
| sort -count
| head 15
          </query>
          <earliest>-4h</earliest>
          <latest>now</latest>
          <refresh>60s</refresh>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
  </row>
</dashboard>

